package com.ht.action.drawtask.taskbook.book;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.io.OutputStream;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.annotation.Resource;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang3.StringUtils;
import com.ht.action.base.BaseAction;
import com.ht.common.util.DataConverter;
import com.ht.common.util.LogHelper;
import com.ht.common.util.LoginUtil;
import com.ht.common.util.MSWordTool;
import com.ht.front.pages.drawtask.taskbook.TaskBookPage;
import com.ht.persistence.dao.inter.system.workflow.publish.VProcessDetailDao;
import com.ht.persistence.model.background.authority.role.RoleUsers;
import com.ht.persistence.model.background.organization.employee.User;
import com.ht.persistence.model.background.organization.organization.Organization;
import com.ht.persistence.model.drawtask.plan.Plan;
import com.ht.persistence.model.drawtask.taskbill.TaskBill;
import com.ht.persistence.model.drawtask.taskbook.book.TaskBook;
import com.ht.persistence.model.drawtask.taskbook.book.TaskBookEditHis;
import com.ht.persistence.model.drawtask.taskbook.book.TaskBookList;
import com.ht.service.inter.background.authority.role.RoleUsersService;
import com.ht.service.inter.background.dicdata.basedata.BaseDataService;
import com.ht.service.inter.background.organization.employee.UserService;
import com.ht.service.inter.background.organization.organization.OrganizationService;
import com.ht.service.inter.drawtask.plan.PlanService;
import com.ht.service.inter.drawtask.taskbill.TaskBillService;
import com.ht.service.inter.drawtask.taskbook.book.TaskBookService;
import com.ht.service.inter.drawtask.taskbook.relation.TaskBookPlanRelationService;

/**
 * 处理编绘任务书Action类
 * 
 * @author PeNgHaO
 */

@SuppressWarnings("serial")
public class TaskBookAction extends BaseAction {

	@Resource(name = "taskBookService")
	private TaskBookService taskBookService;

	@Resource(name = "taskBillService")
	private TaskBillService taskBillService;

	@Resource(name = "organizationService")
	private OrganizationService organizationService;

	@Resource(name = "taskBookPlanRelationService")
	private TaskBookPlanRelationService taskBookPlanRelationService;

	@Resource
	private BaseDataService baseDataService;

	@Resource
	VProcessDetailDao vProcessDetailDao;
	/**
	 * 注入用户Service类
	 */
	@Resource(name = "userService")
	private UserService userService;
	/**
	 * 注入RoleUserService类
	 */
	@Resource(name = "roleUsersService")
	private RoleUsersService roleUsersService;
	/**
	 * 注入计划的service
	 */
	@Resource(name = "planService")
	private PlanService planService;
	// 必须的参数，参数名与表单名相同
	private File upload;
	// 必须的参数，格式：表单名+FileName，表示上传的文件名
	private String uploadFileName;
	// 必须的参数，格式：表单名+ContentType，表示上传文件类型
	private String uploadContentType;

	private TaskBook taskBook;

	private String taskBookType;

	public String getTaskBookType() {
		return taskBookType;
	}

	public void setTaskBookType(String taskBookType) {
		this.taskBookType = taskBookType;
	}

	public TaskBook getTaskBook() {
		return taskBook;
	}

	public void setTaskBook(TaskBook taskBook) {
		this.taskBook = taskBook;
	}

	public File getUpload() {
		return upload;
	}

	public void setUpload(File upload) {
		this.upload = upload;
	}

	public String getUploadFileName() {
		return uploadFileName;
	}

	public void setUploadFileName(String uploadFileName) {
		this.uploadFileName = uploadFileName;
	}

	public String getUploadContentType() {
		return uploadContentType;
	}

	public void setUploadContentType(String uploadContentType) {
		this.uploadContentType = uploadContentType;
	}

	/**
	 * 进入编绘任务书首页
	 * 
	 * @return
	 */
	public String index() {
		String taskBookType = this.getParam("taskBookType");
		try {
			String userNo = LoginUtil.getInstance().getLoginNo(request);
			List<User> users = userService.getUserByNo(userNo);
			String userId = null;
			if (users != null)
			{
				userId = users.get(0).getId();
			}
			// 根据当前登录人获取拥有的角色列表
			List<RoleUsers> roleList = roleUsersService.getRoleUsersByUserId(userId);
			List<String> jurisList=new ArrayList<String>(); 
			jurisList.add("11031903128270101");
			boolean jurisdiction = this.getUserJurisdiction(roleList, jurisList);
			if (taskBookType == null) {
				taskBookType = this.taskBookType;
			}
			TaskBookPage page = new TaskBookPage();
			
			String html = page.getListPage(taskBookService, taskBookType,
					baseDataService,jurisdiction);
			request.setAttribute("html", html);
		} catch (Exception e) {
			LogHelper.ERROR.log(e.getMessage(), e);
			return ERROR;
		}
		return SUCCESS;
	}

	/**
	 * 获取目录明细列表
	 */
	public void getTaskBookList() {
		String year = getParam("year");
		year = year == null ? "2016" : year;// 2016/12/1
											// 日，huodesheng增加，为解决查询不出数据的问题。
		try {
			String userNo = LoginUtil.getInstance().getLoginNo(request);
			List<User> users = userService.getUserByNo(userNo);
			String userId = null;
			if (users != null)
			{
				userId = users.get(0).getId();
			}
			// 根据当前登录人获取拥有的角色列表
			List<RoleUsers> roleList = roleUsersService.getRoleUsersByUserId(userId);
			List<String> jurisList=new ArrayList<String>(); 
			jurisList.add("11031903128270101");
			boolean jurisdiction = this.getUserJurisdiction(roleList, jurisList);
			List<TaskBookList> booklist = taskBookService.findList(year,jurisdiction);
			writeSuccessResult(booklist);
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
	}

	/**
	 * 回显任务计划书
	 */
	public void selectPlan() {
		try {
			String taskBookId = this.getParam("taskBookId");
			List<TaskBill> list = taskBillService
					.findListByTaskBookId(taskBookId);
			List<Plan> planList = new ArrayList<Plan>();
			if(list != null){
				if(list.size()>0){
					Plan plan = list.get(0).getPlan();
					if (plan != null) {
						plan.setRevision(list.get(0).getRevision());
						planList.add(plan);
					}
				}
			}
			/*if (list != null) {
				for (int i = 0; i < list.size(); i++) {
					Plan plan = list.get(i).getPlan();
					if (plan != null) {
						plan.setRevision(list.get(i).getRevision());
						planList.add(plan);
					}
				}
			}*/
			writeSuccessResult(planList);
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
	}

	/**
	 * 编辑编绘任务书
	 */
	public void update() {
		try {
			String userNo = LoginUtil.getInstance().getLoginNo(request);
			// 计划ID
			String planId = this.getParam("planId");
			// 版次
			String revision = this.getParam("revision");
			// 流程实例ID
			String processInstId = this.getParam("processInstId");
			// 流程任务ID
			String taskId = this.getParam("taskId");
			String[] planIds = null;
			String[] revisions = null;
			if (StringUtils.isNotEmpty(planId)) {
				planIds = planId.split(",");
				revisions = revision.split(",");
			}
			taskBookService.modifyTaskBook(taskBook, planIds,revisions);
/*			taskBookService.modifyTaskBook(taskBook, planIds, revisions,
					processInstId, taskId, userNo);
*/			writeSuccessResult();
		} catch (Exception e) {
			writeFailResult(e.getMessage());
		}
	}

	/**
	 * 上传
	 */
	public void uploadFile() {
		try {
			String id = this.getParam("taskbookId");
			taskBookService.uploadFile(upload, uploadFileName, id);
			writeSuccessResult("success");
		} catch (Exception e) {
			writeSuccessResult("error");
			e.printStackTrace();
			// 写入错误日志
			LogHelper.ERROR.log(e.getMessage(), e);
		}
	}

	/**
	 * 前往编辑页面
	 * 
	 * @return
	 * @throws Exception
	 */
	public String editPage() throws Exception {
		// getEditPage
		TaskBookPage page = new TaskBookPage();
		String id = this.getParam("id");
		String flag = this.getParam("flag");
		// 流程实例ID
		String processInstId = getParam("processInstId");
		// 流程任務ID
		String taskId = getParam("taskId");
		// 流程实例ID
		String processDefId = getParam("processDefId");
		// 流程任務ID
		String taskDefId = getParam("taskDefId");
		// 任务书类型
		String taskBookType = this.getParam("taskBookType");
		if (StringUtils.isEmpty(taskBookType)) {
			taskBookType = processDefId.split(":")[0];
		}
		String userNo = LoginUtil.getInstance().getCurrentUser();
		List<User> users = userService.getUserByNo(userNo);
		String username = users.get(0).getUserName();

		
		String html = page.getEditPage(taskBookType, taskBookService,
				organizationService, id, processInstId, taskId, processDefId,
				taskDefId, vProcessDetailDao, taskBookPlanRelationService,
				baseDataService,flag);
		request.setAttribute("html", html);
		request.setAttribute("processInstId", processInstId);
		request.setAttribute("taskId", taskId);
		request.setAttribute("username", username);
		return SUCCESS;
	}

	/**
	 * 前往详情页面
	 * 
	 * @return
	 * @throws Exception
	 */
	public String detailsPage() throws Exception {// getEditPage
		TaskBookPage page = new TaskBookPage();
		String id = this.getParam("id");
		TaskBook taskbook = taskBookService.findById(id);
		String html = page.getDetailsPage(taskbook, organizationService);
		request.setAttribute("html", html);
		return SUCCESS;
	}

	/**
	 * 删除任务书
	 */
	public void remove() {
		try {
			String id = getParam("id");
			taskBookService.delTaskBook(id);
			//返回客户端数据
			writeSuccessResult();
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
		
	}
	
	/**
	 * 删除任务书
	 */
	public void removeFile() {
		try {
			String id = getParam("id");
			String enclosure = getParam("enclosure");
			taskBookService.removeFile(id, enclosure);
			//返回客户端数据
			writeSuccessResult();
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
		
	}

	/**
	 * 下载附件
	 */
	public String downLoad() throws Exception {
		try {
			String id = this.getParam("id");
			TaskBook taskbook = taskBookService.findById(id);
			// if(null!=taskbook){
			String enclosure = taskbook.getEnclosure();
			// if(null!=enclosure&&""!=enclosure){
			String[] split = enclosure.split("\\\\");
			String fileName = "";
			// if(split.length!=0){
			fileName = split[split.length - 1];
			// }
			HttpServletResponse response = this.respose;
			// response.setCharacterEncoding("utf-8");
			response.setContentType("multipart/form-data");
			response.setHeader("Content-Disposition", "attachment;fileName="
					+ java.net.URLEncoder.encode(fileName, "UTF-8"));
			// 获取项目在服务器的路径
			String serverPath = request.getServletContext().getRealPath("/");
			// 获取相应文件的流
			File file = new File(serverPath + taskbook.getEnclosure());
			// if(null!=file){
			// 设置文件长度
			response.setHeader("Content-Length", (int) file.length() + "");
			// IO流复制
			InputStream inputStream = new FileInputStream(file);
			OutputStream os = response.getOutputStream();
			int length;
			while ((length = inputStream.read()) != -1) {
				os.write(length);
			}
			// 释放资源
			inputStream.close();
			os.flush();
			os.close();
			return SUCCESS;
			// }
			// }
			// }
		} catch (Exception e) {
			// 写入错误日志
			// writeSuccessResult("暂无附件");
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			return "loadError";
		}

	}

	/**
	 * 导出任务书
	 * 
	 * @throws Exception
	 */
	public void Export() throws Exception {
		HttpServletResponse response = this.respose;
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		response.setContentType("multipart/form-data");
		// 获取任务书id
		String id = this.getParam("id");
		TaskBookList taskbook = new TaskBookList();
		String executeDept = null;
		try {
			// 获取任务书内容,获取计划列表
			if (StringUtils.isNotEmpty(id)) {
				// 获取任务书
				taskbook = taskBookService.findBookListByid(id);
				String bookName = taskbook.getTaskbookName();
				bookName = new String(bookName.getBytes(), "ISO8859-1");
				response.setHeader("Content-Disposition",
						"attachment;fileName="+bookName+".doc");
				// 获取计划列表
				List<TaskBill> list = taskBillService
						.findListByTaskBookId(taskbook.getId());
				List<Plan> planList = new ArrayList<Plan>();
				if (list != null) {
					for (int i = 0; i < list.size(); i++) {
						Plan plan = list.get(i).getPlan();
						if (plan != null) {
							plan.setRevision(list.get(i).getRevision());
							planList.add(plan);
						}
					}
				}
				// 获取执行部门列表
				String executeDeptId = taskbook.getExecuteDeptId();
				if (null != executeDeptId && !"".equals(executeDeptId)) {
					String[] executeDeptIdList = executeDeptId.split(",");
					for (String string : executeDeptIdList) {
						Organization organization = organizationService
								.getOrganization(string);
						if (organization != null) {
							if (executeDept == null && !"".equals(executeDept)) {
								executeDept = organization.getOrgName();
							} else {
								executeDept = executeDept + ","
										+ organization.getOrgName();
							}
						}
					}
				}
				// 整理任务书数据格式
				Map<String, String> map = new HashMap<String, String>();
				List<Map<String, String>> planmapList = new ArrayList<Map<String, String>>();
				// 任务书数据
				if (taskbook.getTaskbookNo() == null) {
					map.put("text_no", "无");
				} else {
					map.put("text_no", taskbook.getTaskbookNo());
				}

				if (taskbook.getTaskbookName() == null) {
					map.put("text_book_name", "无");
				} else {
					map.put("text_book_name", taskbook.getTaskbookName());
				}

				if (taskbook.getTaskFrom() == null) {
					map.put("text_from", "无");
				} else {
					map.put("text_from", taskbook.getTaskFrom());
				}

				if (taskbook.getItemName() == null) {
					map.put("text_item_name", "无");
				} else {
					map.put("text_item_name", taskbook.getItemName());
				}

				if (executeDept == null) {
					map.put("text_execute_dept", "无");
				} else {
					map.put("text_execute_dept", executeDept);
				}
				if (taskbook.getExecuteTime() == null) {
					map.put("text_execute_time", "无");
				} else {
					map.put("text_execute_time",
							sdf.format(taskbook.getExecuteTime()));
				}

				if (taskbook.getEndTime() == null) {
					map.put("text_end_time", "无");
				} else {
					map.put("text_end_time", sdf.format(taskbook.getEndTime()));
				}

				if (taskbook.getTechnologyStandard() == null) {
					map.put("text_standard", "无");
				} else {
					map.put("text_standard", taskbook.getTechnologyStandard());
				}
				if (taskbook.getTechnologyDemand() == null) {
					map.put("text_demand", "无");
				} else {
					map.put("text_demand", taskbook.getTechnologyDemand());
				}
				if (taskbook.getOtherDemand() == null) {
					map.put("text_other", "无");
				} else {
					map.put("text_other", taskbook.getOtherDemand());
				}
				// 计划数据
				for (Plan plan : planList) {

					Map<String, String> planMap = new HashMap<String, String>();
					if (plan.getMapName() == null) {
						planMap.put("text_tm", "无");
					} else {
						planMap.put("text_tm", plan.getMapName());
					}
					if (plan.getMapNo() == null) {
						planMap.put("text_th", "无");
					} else {
						planMap.put("text_th", plan.getMapNo());
					}
					if (plan.getScale() == null) {
						planMap.put("text_blc", "无");
					} else {
						planMap.put("text_blc", plan.getScale());
					}
					if (plan.getRevision() == null) {
						planMap.put("text_bc", "第1版");
					} else {
						planMap.put("text_bc", "第" + plan.getRevision() + "版");
					}
					planmapList.add(planMap);
				}
				LogHelper.SYSTEM.log(DataConverter.convertObject2Json(planmapList));
				// 获取项目在服务器的路径
				String serverPath = request.getServletContext()
						.getRealPath("/");
				// 获取模版
				File templete = new File(serverPath
						+ "/ht/templete/taskbookTemplete.docx");
				InputStream in = new FileInputStream(templete);
				// 初始化工具类
				MSWordTool changer = new MSWordTool();
				// 放入模板
				changer.setTemplate(in);
				List<String> bookMarksList = changer.getBookMarkStrings();
				if (bookMarksList.size() > 0) {
					// 拥有表格
					for (String bookMark : bookMarksList) {
						// 第一次循环，进行重复性数据替换
						if (bookMark.startsWith("table")) {
							// 简单表格
							changer.fillTableAtBookMark(bookMark, planmapList,true);// 进行重复性数据替换
						}
						
					}
					changer.replaceTitle(map);
					changer.removeMakers();
					changer.save(response.getOutputStream());
				}
				response.getOutputStream().flush();
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	public void issue(){
		String ids = this.getParam("taskBookIds");
		 try {
			taskBookService.issue(ids);
			writeSuccessResult();
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
	}
	
	public void verificationNo(){
		String taskBookNo=getParam("taskbookNo");
		String id=getParam("id");
		try {
			List<TaskBook> list = taskBookService.countByNo(taskBookNo);
			TaskBook taskbook = taskBookService.findById(id);
			if(list!=null&&list.size()>0){
				if(taskbook!=null&&list.size()==1){
					if(taskbook.getId().equals(list.get(0).getId())){
						writeSuccessResult("success");
					}
				}
				writeSuccessResult("error");
			}else{
				writeSuccessResult("success");
			}
		} catch (Exception e) {
			// 写入错误日志
			e.printStackTrace();
			LogHelper.ERROR.log(e.getMessage(), e);
			writeFailResult(e.getMessage());
		}
	}
	


	
	/*
	 * 任务书编辑页面获历史修订记录
	 */
	public void editHisList() throws Exception {
		String id=getParam("id");
		List<TaskBookEditHis> list=new ArrayList<TaskBookEditHis>(); 
         list=taskBookService.findEditListById(id);
            
 		String json = DataConverter.convertObject2Json(list);
 		respose.getWriter().write(json);
  	}
	
	/*
	 * 任务书编辑页面 新增修订记录
	 */
	public void editcontent() throws Exception {
		//任务书ID
		String taskbookid=getParam("taskbookid");
		//任务书编号
		String taskbookNo=getParam("taskbookNo");
      /*	修订内容*/
		String editcount=getParam("editcount");
		//修订人
		String creatro=getParam("creatro");
		//当前时间
		String nowtime=getParam("nowtime");
			
		
	    taskBookService.addTaskBookEdit(taskbookid,editcount,creatro,taskbookNo,nowtime);

		respose.getWriter().write("1");
		
		
  	}
	

	
	
	
	
	
	
	
	
	
	
	
	
}
