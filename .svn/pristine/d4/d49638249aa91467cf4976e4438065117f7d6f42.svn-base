package com.ht.persistence.dao.impl.drawtask.taskbook.book;

import java.util.List;

import org.hibernate.Query;
import org.hibernate.SQLQuery;
import org.springframework.util.CollectionUtils;

import com.ht.common.util.LogHelper;
import com.ht.persistence.dao.impl.base.BaseDaoImpl;
import com.ht.persistence.dao.inter.drawtask.taskbook.book.TaskBookDao;
import com.ht.persistence.model.background.dicdata.basedata.BaseData;
import com.ht.persistence.model.drawtask.taskbook.book.TaskBook;
import com.ht.persistence.model.drawtask.taskbook.book.TaskBookList;
import com.ht.persistence.model.drawtask.taskbook.book.VTaskBook;
import com.ht.service.impl.background.dicdata.constants.BaseDataConstants;

/**
 * 编绘任务书
 * @author huodesheng
 *
 */
public class TaskBookDaoImpl extends BaseDaoImpl implements TaskBookDao {

	@SuppressWarnings("unchecked")
	@Override
	public TaskBook findById(String id) throws Exception {
		List<TaskBook> result = null;
		try {
			Query setParameter = this.getSession().createQuery(" from TaskBook where id = :id").setParameter("id", id);
//			result = this.findByNamedParam("findTaskBookById","id",id);
			result = setParameter.list();
			if(CollectionUtils.isEmpty(result)){
				return null;
			}
		} catch (Exception e) {
			System.out.println(e.getMessage());
			e.printStackTrace();
			return null;
		}
		return result.get(0);
	}
	@Override
	public TaskBookList findBookListByid(String id) throws Exception {
		List<TaskBookList> result = null;
		try {
			SQLQuery query = this.getSession().createSQLQuery("select t.*,b.value from COMPILATION_TASK_BOOK t , BASE_DATA b where  b.type_id=? and t.TASKBOOK_TYPE=b.code and t.id=?");
			query.setString(0,BaseDataConstants.TASK_BOOK_TYPE);
			query.setString(1, id);
			query.addEntity(TaskBookList.class);
			result=query.list();
			if(CollectionUtils.isEmpty(result)){
				return null;
			}
		} catch (Exception e) {
			System.out.println(e.getMessage());
			e.printStackTrace();
			return null;
		}
		return result.get(0);
	}

	@Override
	public List<TaskBook> findList() throws Exception {
		List<TaskBook> list = null;
		try {
			
			list = this.findByNamedQuery("findTaskBookList");
			if(CollectionUtils.isEmpty(list)){
				return null;
			}
		} catch (Exception e) {
			System.out.println(e.getMessage());
			return null;
		}
		return list;
	}

	@Override
	@SuppressWarnings("unchecked")
	public List<TaskBookList> findListIncludeTypeName(String year) throws Exception {
		List<TaskBookList> appList = null;
		try
		{
			SQLQuery query = this.getSession().createSQLQuery("select t.* from COMPILATION_TASK_BOOK t where to_char(t.creation_date,'yyyy')=? and t.state ='已下发' order by t.creation_date desc");
			query.setString(0, year);
			query.addEntity(TaskBookList.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}
	
	@Override
	public long count() throws Exception {
		return 0;
	}

	@Override
	public boolean exists(String taskBookNo) throws Exception {
		return false;
	}

	@Override
	public void addTaskBook(TaskBook taskBook) throws Exception {
		this.save(taskBook);
	}

	@Override
	public void modifyTaskBook(TaskBook taskBook) throws Exception {
		this.saveOrUpdate(taskBook);
	}

	@Override
	public void delTaskBook(String id) throws Exception {
		this.delete(id);
	}

	@Override
	public void delTaskBook(TaskBook taskBook) throws Exception {
		this.delete(taskBook);
	}

	@Override
	public List<TaskBook> countByNo(String noName) throws Exception {
		try {
			
			String hql="from TaskBook taskBook where taskBook.taskbookNo like :param";
			return this.getSession().createQuery(hql).setString("param", "%"+noName+"%").list();
		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
		}
		return null;
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<BaseData> getTechnologyDemand() throws Exception {
		String hql="from BaseData baskData where baskData.typeName = :param order by baskData.code";
		return this.getSession().createQuery(hql).setString("param","技术要求").list();
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<TaskBook> findByType(String taskBookType) throws Exception {
		return this.findByNamedQueryAndNamedParam("findTaskBookByType", "taskBookType", taskBookType);
	}

	@Override
	public List<TaskBook> findFiveList() {
		@SuppressWarnings("unchecked")
		List<TaskBook> list = this.findByNamedQuery("findTaskBookList");
		if (list.size()>=5) {
			list = list.subList(0, 5);
		}
		return list;
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<BaseData> getOtherDemand() throws Exception {
		String hql="from BaseData baskData where baskData.typeName = :param order by baskData.code";
		return this.getSession().createQuery(hql).setString("param","其他要求").list();
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<BaseData> getTechnologyStandard() throws Exception {
		String hql="from BaseData baskData where baskData.typeName = :param order by baskData.code";
		return this.getSession().createQuery(hql).setString("param","技术标准").list();
	}

	/**
	 * 获取版次
	 * */
	@SuppressWarnings("unchecked")
	@Override
	public List<BaseData> getVersion() throws Exception {
		String hql="from BaseData baskData where baskData.typeName = :param order by baskData.code";
		return this.getSession().createQuery(hql).setString("param","版次").list();
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<TaskBookList> findListCorrectionNotice() throws Exception
	{
		List<TaskBookList> appList = null;
		try
		{
			SQLQuery query = this.getSession().createSQLQuery("select t.*,b.value from COMPILATION_TASK_BOOK t , BASE_DATA b where  b.type_id=? and t.TASKBOOK_TYPE=b.code and TASKBOOK_TYPE = 'TASK_BOOK_CORRECTION_NOTICE' order by NOTICE_NO desc");
			query.setString(0,BaseDataConstants.TASK_BOOK_TYPE);
			query.addEntity(TaskBookList.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}

	@SuppressWarnings("unchecked")
	@Override
	public List<TaskBook> findListCorrectionNoticeByYear(String year) throws Exception
	{
		List<TaskBook> appList = null;
		try
		{
			SQLQuery query = this.getSession().createSQLQuery("select t.* from COMPILATION_TASK_BOOK t , BASE_DATA b where  b.type_id=? and t.TASKBOOK_TYPE=b.code and TASKBOOK_TYPE = 'TASK_BOOK_CORRECTION_NOTICE' and to_char(t.creation_date,'yyyy')=? order by NOTICE_NO desc");
			query.setString(0,BaseDataConstants.TASK_BOOK_TYPE);
			query.setString(1,year);
			query.addEntity(TaskBook.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}
	@Override
	public List<TaskBookList> findListByYearAndState(String year, String state) throws Exception
	{
		List<TaskBookList> appList = null;
		try
		{
			SQLQuery query = this.getSession().createSQLQuery("select t.* from COMPILATION_TASK_BOOK t where to_char(t.creation_date,'yyyy')=?  and t.state=? order by t.creation_date desc");
			query.setString(0, year);
			query.setString(1, state);
			query.addEntity(TaskBookList.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}
	@Override
	public List<VTaskBook> findCreateTaskListByYearAndState(String year, String state) throws Exception
	{
		List<VTaskBook> appList = null;
		try
		{
			SQLQuery query = this.getSession().createSQLQuery("select t.* from V_COMPILATION_TASK_BOOK_NUMBER t where to_char(t.creation_date,'yyyy')=?  and t.state=? order by t.creation_date desc");
			query.setString(0, year);
			query.setString(1, state);
			query.addEntity(VTaskBook.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}

	/**
	 * 下发
	 */
	@Override
	public void issue(TaskBook tb) throws Exception
	{
		this.update(tb);
	}
	
	@Override
	@SuppressWarnings("unchecked")
	public List<TaskBookList> findList(String year,boolean jurisdiction) throws Exception {
		List<TaskBookList> appList = null;
		try
		{
			String sql="select t.* from COMPILATION_TASK_BOOK t where t.state='已下发' and to_char(t.creation_date,'yyyy')=? order by t.creation_date desc";
			if(jurisdiction){
				sql="select t.* from COMPILATION_TASK_BOOK t where to_char(t.creation_date,'yyyy')=? order by t.creation_date desc";
			}
			SQLQuery query = this.getSession().createSQLQuery(sql);
			query.setString(0, year);
			query.addEntity(TaskBookList.class);
			appList=  query.list();
		}
		catch (Exception e)
		{
			LogHelper.ERROR.log(e.getMessage());
		}
		return appList;
	}
}
