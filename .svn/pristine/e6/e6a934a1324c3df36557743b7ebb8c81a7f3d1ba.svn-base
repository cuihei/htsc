package com.ht.action.statisticalanalysis;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.commons.lang3.StringUtils;
import org.apache.xmlbeans.impl.xb.xsdschema.Public;

import com.ht.action.base.BaseAction;
import com.ht.common.util.DateComparator;
import com.ht.common.util.LogHelper;
import com.ht.front.pages.statisticalanalysis.ChartCompletionPage;
import com.ht.persistence.util.PageObject;
import com.ht.service.inter.statisticalanalysis.CompilationChildTaskService;
import com.ht.service.inter.system.workflow.task.TaskService;
import com.sun.org.apache.bcel.internal.generic.NEW;

/**
 * 海图完成情况action
 * 
 * @author 侯晨
 *
 */
@SuppressWarnings("serial")
public class ChartCompletionAction extends BaseAction {

	/**
	 * 注入TaskService
	 */
	@Resource
	TaskService taskService;
	@Resource
	CompilationChildTaskService compilationChildTaskService;

	/**
	 * 初始化海图完成情况页面，返回成功列表页面
	 */
	public String init() {
		String key = this.getParam("processDefKey");
		String isComplete = getParam("isComplete");
		String type = getParam("type");
		ChartCompletionPage ccp = new ChartCompletionPage();
		// 将获取的节点字符串返回到前台页面
		request.setAttribute("isComplete", isComplete);
		request.setAttribute("type", type);
		List<String> list = null;
		try {
			list = compilationChildTaskService.getYearList();
		} catch (Exception e) {
			e.printStackTrace();
		}
		request.setAttribute("html", ccp.getListPage(key, list));
		return SUCCESS;
	}

	/**
	 * 获取所有海图完成情况
	 */
	public void getChartCompletion() {
		String page = getParam("page");
		String pageSize = getParam("pageSize");
		PageObject p = new PageObject();
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy");
		String year = sdf.format(new Date());
		try {
			String isComplete = getParam("isComplete");
			String key = this.getParam("processDefKey");
			List<Map<String, Object>> list = null;
			int total = 0;
			if (StringUtils.isNotEmpty(key)) {
				if (isComplete.equals("true")) {
					list = taskService.getCompleteTaskByKey(key, page, pageSize, year);
					if (list.size() > 0) {
						Collections.sort(list, new DateComparator());
					}
					total = taskService.getCompleteTaskByKeyCount(key);
				} else {
					list = taskService.getRuTaskByKey(key, page, pageSize, year);
					if (list.size() > 0) {
						Collections.sort(list, new DateComparator());
					}
					total = taskService.getRuTaskByKeyCount(key);
				}
			} else {
				if (isComplete.equals("true")) {
					list = taskService.getCompleteTask(page, pageSize, year);
					total = taskService.getCompleteTaskCount();
					if (list.size() > 0) {
						Collections.sort(list, new DateComparator());
					}
				} else {
					list = taskService.getRuTaskAll(page, pageSize, year);
					total = taskService.getRuTaskAllCount();
					if (list.size() > 0) {
						Collections.sort(list, new DateComparator());
					}
				}
			}
			// 返回客户端消息
			p.setList(list);
			p.setTotal(total);
			writeSuccessResult(p);
		} catch (Exception e) {
			// 写入错误日志
			LogHelper.ERROR.log(e.getMessage(), e);
			// 返回客户端错误消息
			writeFailResult(e.getMessage());
		}
	}

	/**
	 * 获取所有海图完成情况
	 */
	public void getAllChartCompletion() {
		String page = getParam("page");
		String pageSize = getParam("pageSize");
		String compType = getParam("compType");
		PageObject p = new PageObject();
		String plan = getParam("type");
		String year = getParam("year");
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		try {
			if ((plan != null) && (plan.equals("plan"))) {
						if (compType.equals("0")) {
							List<Map<String, Object>> listAll = this.taskService.getTaskAllPlan(year, compType);
							p.setList(listAll);
							p.setTotal(Integer.valueOf(listAll.size()));
						} else if (compType.equals("1")) {
							List<Map<String, Object>> listAll = this.taskService.getTaskAllPlan(year, compType);
							p.setList(listAll);
							p.setTotal(Integer.valueOf(listAll.size()));
						} else if (compType.equals("2")) {
							List<Map<String, Object>> listAll = this.taskService.getTaskAllPlan(year, compType);
							p.setList(listAll);
							p.setTotal(Integer.valueOf(listAll.size()));
						}
			} else if ((plan != null) && (plan.equals("distribution"))) {
						List<Map<String, Object>> list1 = this.taskService.getRuTaskAllDis();
						p.setList(list1);
						p.setTotal(Integer.valueOf(list1.size()));
			} else if (compType.equals("0")) {
				List<Map<String, Object>> listAll = this.taskService.getTaskAll(year, compType);
				p.setList(listAll);
				p.setTotal(Integer.valueOf(listAll.size()));
			} else if (compType.equals("1")) {
				List<Map<String, Object>> listAll = this.taskService.getTaskAll(year, compType);
				p.setList(listAll);
				p.setTotal(Integer.valueOf(listAll.size()));
			} else if (compType.equals("2")) {
				List<Map<String, Object>> listAll = this.taskService.getTaskAll(year, compType);
				p.setList(listAll);
				p.setTotal(Integer.valueOf(listAll.size()));
				p.getmsg("1");
				
			}
			if (p.getTotal().intValue() == 0) {
				writeSuccessResult("数据库文件为空");
			} else {
				writeSuccessResult(p);
			}
		} catch (Exception e) {
			LogHelper.ERROR.log(e.getMessage(), e);

			writeFailResult(e.getMessage());
		}
	}

	/**
	 * 根据key获取海图完成情况
	 */
	public void getChartCompletionByKey() {
		String page = getParam("page");
		String pageSize = getParam("pageSize");
		PageObject p = new PageObject();
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy");
		String year = sdf.format(new Date());
		try {
			String key = this.getParam("processDefKey");
			String isComplete = getParam("isComplete");
			List<Map<String, Object>> list = null;
			int count = 0;
			if (isComplete.equals("true")) {
				list = taskService.getCompleteTaskByKey(key, page, pageSize, year);
				count = taskService.getCompleteTaskByKeyCount(key);
			} else {
				list = taskService.getRuTaskByKey(key, page, pageSize, year);
				count = taskService.getRuTaskByKeyCount(key);
			}
			p.setList(list);
			p.setTotal(count);
			// 返回客户端消息
			writeSuccessResult(p);
		} catch (Exception e) {
			// 写入错误日志
			LogHelper.ERROR.log(e.getMessage(), e);
			// 返回客户端错误消息
			writeFailResult(e.getMessage());
		}
	}

	public void taskrun() throws Exception {
		try {
			
			String page = "1";
			String pageSize = "-1";
			List<String> yearAll = new ArrayList<String>();
			List<Map<String,Object>> listall=new ArrayList<Map<String,Object>>();
			yearAll = this.taskService.getAllTaskYear();
			String year = null;
			if (yearAll.size() > 0) {
				for (int x = 0; x < yearAll.size(); x++) {
					year = (String) yearAll.get(x);
					List<Map<String, Object>> list0 = this.taskService.getRuTaskAllByYear(page, pageSize, year);
					 listall.addAll(list0);
					List<Map<String, Object>> list1 = this.taskService.getCompleteTaskByYear(page, pageSize, year);
					listall.addAll(list0);
				}
				this.taskService.delAllTempTask();
				this.taskService.addTaslAllList(listall);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	public void planrun() throws Exception {
		try {
			String page = "1";
			String pageSize = "-1";
			List<String> yearAll = new ArrayList<String>();
			yearAll = this.taskService.getAllTaskYear();
			List<Map<String,Object>> listall=new ArrayList<Map<String,Object>>();
			String year = null;
			if (yearAll.size() > 0) {
				for (int x = 0; x < yearAll.size(); x++) {
					year = (String) yearAll.get(x);
				   List<Map<String, Object>> list0 = this.taskService.getPlanCompleteTask(page, pageSize, year);
			        listall.addAll(list0);
					List<Map<String, Object>> list1 = this.taskService.getPlanRuTask(page, pageSize, year);
			        listall.addAll(list1);
				}
				this.taskService.delAllTempTaskPlan();
				this.taskService.addTaslAllListPlan(listall);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
